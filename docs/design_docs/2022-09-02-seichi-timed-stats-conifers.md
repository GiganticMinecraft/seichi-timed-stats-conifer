# 時系列統計データストアとしての `seichi-timed-stats-conifers`

## 文脈

2022/10 月現在、整地ランキングシステムは幾つかの問題を抱えている。これには例えば以下のような点が挙げられる：

- 永続データが SeichiAssist と共有されたデータベース上に保存されており、しかもその仕組みにアプリケーションが依存してしまっていること。これによって SeichiAssist と切り離して運用をすることが難しくなっている。
- 永続データの信頼性。オーバーフローした可能性のあるデータだったり、時間カラムが正しくなさそうなデータなどが混ざっている。
- 利用されているデータ構造の冗長性によるストレージ圧迫。
- データ構造がランキングデータの生成に向いていないこと。アクセスパフォーマンスの悪化を招いている。

@inductor がインデックスを貼りなおす等の一時処置を行い、クエリが 100 倍程度は速くなった(\[要出典\])そうだが、それでもタイムアウトの上限に間に合わなかったため、さらなる改修が必要であると結論した。

しかしながら、データもあまり信頼性が高くなかったのと、*我々は闇が垣間見える PHP で書かれたシステムの改修をしたくなかった*という二つの点から、システムを根本的にリプレイスして、構成から考えなおすことにした。

---

ランキングシステムは、「プレーヤーデータの(整地鯖システム内での)公開」、「過去のプレーヤーデータの蓄積とアクセス」及び「ランキング情報の計算とそのキャッシュの保持」の三つの機能を組み合わせて初めてバックエンドの機能が実現できる。

新システムの設計においては、これら三つの機能は独立した機能だと考え、各々をマイクロサービスのコンポーネントとして実装することにした。本ドキュメントの関心の対象である `seichi-timed-stats-conifers` は、「過去のプレーヤーデータの蓄積とアクセス」を実現するシステムとして設計する。

## 目標

### 実現すべきこと (Goals)

#### 機能要件

- 全プレーヤーの各種統計(とりあえずは整地量、建築量、プレイティック数、投票数)を、統計量を読み取った正確なタイミングとともに蓄積することができる
- 任意に与えられた時刻について、その時刻の直前に蓄積された全プレーヤーの統計量データを読み出すことができる

#### 非機能要件

- 過去の統計量データの読み出しは 1 秒程度で完了するのが望ましい
- データの蓄積に使う形式は、ディスク使用量が少ないものであることが望ましい

### 実現しないこと (non-Goals)

- ランキング情報の生成。これは、 `seichi-timed-stats-conifers` に対して API 呼び出しを行うような別コンポーネントにて実装する。

## 用語の定義

以下、整地量、建築量などの、プレーヤーに対して集計されるような数値の種類の事を **統計量** と呼ぶことにする。

統計量 `Stat` について、プレーヤーの集合 `P` から `Stat` への関数的な関係、つまり、何らかの関数 `statOf: P → Stat` についての集合 `{ (p, statOf(p)) | p: P }`) を **`Stat` の集計** と呼ぶことにする。 `Stat` が文脈から明らか、又は重要ではない場合は、単に **統計量集計** と呼ぶことにする。

(TODO: 例や図を入れる)

特定時刻 `t` での全プレーヤの集まり `Players(t)` から統計量 `Stats` の値の集まり、つまり、集合 `{ (p, p の統計量 Stat の値) | p は t の時点でのプレーヤー }` のことを **`Stat` に関する `t` での統計量スナップショット** と呼ぶことにする。統計量 `Stat` や時刻 `t` が文脈から明らか、又は重要でない場合は、これを省略して単に **統計量スナップショット** と呼ぶことにする。定義より、統計量スナップショットは統計量集計である。

(TODO: 例や図を入れる)

統計量スナップショット `s` の部分集合を **`s` の部分スナップショット** と呼ぶことにする。

(TODO: 例や図を入れる)

統計量 `S` に関する二つの統計量スナップショット `s1`、 `s2` があった時、 **`s2` の `s1` からの差分** とは、`s2` の中のプレーヤーと統計量の組 `(p, v)` であって、 `s1` に属さないものの集まりとする。集合記法を用いれば、これは `{ (p, v) ∈ s2 | (p, v) ∉ s1 }` となる。また、これを単に `s2 \ s1` とも書くことにする。定義より、 `s2` の `s1` からの差分は `s2` の部分スナップショットであり、これは統計量集計である。

統計量スナップショット `snap` と、(スナップショットとは限らない)統計量集計 `st` について、 **`snap` の `st` での上書き** とは、`st` のデータで `snap` を上書きした統計量集計であり、 `{ (p, v) ∈ snap | p は st に現れない } ∪ st` で表される。

## どのように実現するか

### データの永続化方法について

RDB を用いてデータを永続化する。ディスク使用量を少なくし、読み出しをそれなりに高速にするため、以下のような手法を取る。

- サーバーの内部状態として、「最新の統計量スナップショット」を持つ
  - つまり、サーバー起動時には一度統計量スナップショットを (`seichi-game-data-server` から取得したデータで) 作成し、それを RDB に書き込んだうえで「最新の統計量スナップショット」とする。
- 定期的に統計量スナップショットを作成し、RDB に書き込む
  - 書き込んだデータを「最新の統計量スナップショット」とする
- 5 分といった短い期間ごとに、全プレーヤーの統計量をゲームデータサーバーから読み出し、統計量スナップショット `newSnapshot` を作成する。「最新の統計量スナップショット」が `snap` のとき、 `newSnapshot` の `snap` からの差分を RDB に書き込む
  - `newSnapshot` を「最新の統計量スナップショット」とする

という方式を取る。

### データベースに課す不変量

データベース D について、次のような有向グラフ G_D = (V_D, E_D) を考える。

- V_D = D の 差分データと統計量スナップショットの集合
- E_D = `{ (base(d), d) | d は D の差分データ }`

データ不整合をなるべく防ぐという観点から、データベース D 全体に仮定する不変量は

- G_D が有向森となる
- E_D の辺 `(s, t)` について、 `s` の時刻は `t` の時刻未満となる

**のみ** とする。つまり、差分データの枝分かれがあっても良いし、差分データが必ず直前の差分データや統計量スナップショットを基底とするとは限らない。

### 具体的なスキーマ

差分データでは UUID が占める容量が大きくなると想定されるため、UUID をより小さい `bigint` に落とす `uuid_mapping` テーブルを用意する。

整地量を保存するテーブルは、[このような設計](https://github.com/GiganticMinecraft/seichi-timed-stats-conifers/blob/1c0ec13e4b26bb2e07418f393ca5a5a72feebb4a/database/schema.sql#L7-L44)になる。

その他の統計量を保存するテーブルは、整地量を保存するテーブルと同じ形式のものを用意する。

## 検討した代替案 (Alternatives Considered)

### 差分データにて統計量の数値差分ではなく絶対値を持ちまわしている理由

(プレーヤーの統計量の時系列を取るのが一クエリでできるから、というのを書く)

### データの永続化に利用するミドルウェア

(TSDB を検討したが、 large series cardinality 問題により採用しなかった理由を述べる)

### データの永続化手法について

(深さ高々 2 の形の木や skiplist 的な構造なども検討したが、複雑性やデータ使用量の都合から採用しなかった旨を述べる)

## 備考

### 名前の由来について

[どのように実現するか](#どのように実現するか) の節で説明したように、 `seichi-timed-stats-conifers` は「大きな枝分かれが基本的に発生しないような、親ノードとの差分を記録する木構造の集まり」にて時系列上の統計量データを記録する。

(グラフ理論的な)木の集まりは(グラフ理論的な)森と呼ばれており、「枝分かれが少ない木の集合」を @kory33 が「針葉樹林みたいだなぁ」と思ったことから、 `conifers` という名前を付けることになった。

![Abies lasiocarpa](../400px-Abies_lasiocarpa_5922.jpg)

[Abies lasiocarpa 5922](https://commons.wikimedia.org/wiki/File:Abies_lasiocarpa_5922.JPG), by Walter Siegmund.
